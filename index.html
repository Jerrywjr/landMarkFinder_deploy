<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<title>ğŸ›ï¸ LandMarkFinder - AI Landmark Recognition Guide</title>
<style>
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  body {
    font-family: "Inter", "Helvetica Neue", Arial, sans-serif;
    background: linear-gradient(145deg, #e0f2fe, #f8fafc);
    margin: 0;
    padding: 20px;
    min-height: 100vh;
  }

  .container {
    display: flex;
    max-width: 1200px;
    margin: 0 auto;
    gap: 30px;
    height: calc(100vh - 40px);
  }

  .left-panel, .right-panel {
    background: rgba(255, 255, 255, 0.85);
    backdrop-filter: blur(10px);
    border-radius: 20px;
    box-shadow: 0 10px 35px rgba(0, 0, 0, 0.1);
    padding: 30px;
  }

  .left-panel {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .right-panel {
    flex: 1.5;
    display: flex;
    flex-direction: column;
  }

  .header-section {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 100%;
    margin-bottom: 20px;
  }

  .title-container {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    margin-bottom: 10px;
  }

  h2 {
    font-weight: 700;
    color: #0f172a;
    display: flex;
    align-items: center;
    gap: 8px;
    margin: 0;
  }

  .language-selector {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 15px;
  }

  .language-selector label {
    color: #475569;
    font-size: 14px;
    font-weight: 500;
  }

  .language-selector select {
    padding: 6px 12px;
    border-radius: 8px;
    border: 2px solid #e2e8f0;
    background: white;
    color: #334155;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .language-selector select:hover {
    border-color: #3b82f6;
  }

  .language-selector select:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }

  .language-info {
    font-size: 12px;
    color: #64748b;
    text-align: center;
    margin-top: 5px;
    padding: 5px 10px;
    background: #f1f5f9;
    border-radius: 6px;
  }

  .subtitle {
    color: #475569;
    text-align: center;
    margin-bottom: 30px;
    font-size: 15px;
  }

  .upload-area {
    width: 100%;
    margin-bottom: 30px;
  }

  .file-input-container {
    position: relative;
    width: 100%;
    height: 200px;
    border: 3px dashed #cbd5e1;
    border-radius: 16px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s;
    background: #f8fafc;
  }

  .file-input-container:hover {
    border-color: #3b82f6;
    background: #f0f9ff;
  }

  .file-input-container.dragover {
    border-color: #3b82f6;
    background: #dbeafe;
  }

  .upload-icon {
    font-size: 48px;
    color: #94a3b8;
    margin-bottom: 15px;
  }

  .upload-text {
    color: #64748b;
    font-size: 16px;
    margin-bottom: 5px;
  }

  .upload-hint {
    color: #94a3b8;
    font-size: 14px;
  }

  input[type="file"] {
    position: absolute;
    width: 100%;
    height: 100%;
    opacity: 0;
    cursor: pointer;
  }

  .button-group {
    display: flex;
    flex-direction: column;
    gap: 15px;
    width: 100%;
  }

  button {
    width: 100%;
    padding: 14px;
    border: none;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
  }

  .primary-btn {
    background: linear-gradient(135deg, #3b82f6, #2563eb);
    color: white;
    box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
  }

  .primary-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 18px rgba(37, 99, 235, 0.35);
  }

  .secondary-btn {
    background: #f1f5f9;
    color: #475569;
    border: 2px solid #e2e8f0;
  }

  .secondary-btn:hover {
    background: #e2e8f0;
  }

  .preview-section {
    width: 100%;
    margin-top: 30px;
    text-align: center;
  }

  .preview-title {
    color: #475569;
    font-size: 16px;
    margin-bottom: 15px;
    font-weight: 500;
  }

  #preview {
    max-width: 100%;
    max-height: 200px;
    border-radius: 12px;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
    display: none;
  }

  .output-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }

  .output-title {
    color: #0f172a;
    font-size: 18px;
    font-weight: 600;
  }

  .output-actions {
    display: flex;
    gap: 10px;
  }

  .action-btn {
    background: #f1f5f9;
    border: none;
    border-radius: 8px;
    padding: 8px 15px;
    cursor: pointer;
    font-size: 14px;
    color: #475569;
    transition: all 0.2s;
  }

  .action-btn:hover {
    background: #e2e8f0;
  }

  #output {
    flex: 1;
    border-radius: 12px;
    padding: 20px;
    border: none;
    font-size: 15px;
    line-height: 1.6;
    color: #334155;
    background: #f1f5f9;
    white-space: pre-wrap;
    overflow-y: auto;
    font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
    min-height: 300px;
  }

  #output:empty::before {
    content: attr(data-placeholder);
    color: #94a3b8;
    font-style: italic;
  }

  #loading {
    display: none;
    margin: 20px 0;
    text-align: center;
  }

  .spinner {
    border: 4px solid #e2e8f0;
    border-top: 4px solid #3b82f6;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: 0 auto 15px;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  .loading-text {
    color: #64748b;
    font-size: 15px;
  }

  footer {
    margin-top: 30px;
    text-align: center;
    font-size: 13px;
    color: #94a3b8;
  }

  footer span {
    background: #f1f5f9;
    padding: 6px 12px;
    border-radius: 12px;
  }

  /* é”™è¯¯æç¤ºæ ·å¼ */
  .error-message {
    position: fixed;
    top: 20px;
    right: 20px;
    background: #ef4444;
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    z-index: 1000;
    max-width: 300px;
    animation: slideIn 0.3s ease;
  }

  .info-message {
    position: fixed;
    top: 20px;
    right: 20px;
    background: #3b82f6;
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    z-index: 1000;
    max-width: 300px;
    animation: slideIn 0.3s ease;
  }

  @keyframes slideIn {
    from {
      transform: translateX(100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }

  @keyframes slideOut {
    from {
      transform: translateX(0);
      opacity: 1;
    }
    to {
      transform: translateX(100%);
      opacity: 0;
    }
  }

  @media (max-width: 768px) {
    .container {
      flex-direction: column;
      height: auto;
    }
    
    .left-panel, .right-panel {
      width: 100%;
    }
  }
</style>
</head>
<body>
  <div class="container">
    <!-- å·¦ä¾§é¢æ¿ -->
    <div class="left-panel">
      <div class="header-section">
        <div class="title-container">
          <h2>ğŸ›ï¸ <span id="appTitle">LandMarkFinder</span></h2>
        </div>
        
        <div class="language-selector">
          <label for="languageSelect" id="languageLabel">è¯­è¨€ / Language:</label>
          <select id="languageSelect">
            <option value="zh">ä¸­æ–‡ (Chinese)</option>
            <option value="en">English (è‹±è¯­)</option>
            <option value="fr">FranÃ§ais (æ³•è¯­) - Beta</option>
          </select>
        </div>
        
        <div class="language-info" id="languageInfo">
          âœ… ä¸­æ–‡å’Œè‹±æ–‡æ”¯æŒæœ€ä½³ | âœ… Chinese & English best supported
        </div>
        
        <p class="subtitle" id="appSubtitle">ä¸Šä¼ åœ°æ ‡ç…§ç‰‡ï¼ŒAIç”Ÿæˆå¯¼è§ˆä»‹ç»</p>
      </div>
      
      <!-- ä¸Šä¼ åŒºåŸŸ -->
      <div class="upload-area">
        <div class="file-input-container" id="dropArea">
          <div class="upload-icon">ğŸ“</div>
          <div class="upload-text" id="uploadText">ç‚¹å‡»é€‰æ‹©æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤åŒºåŸŸ</div>
          <div class="upload-hint" id="uploadHint">æ”¯æŒ JPGã€PNG æ ¼å¼</div>
          <input type="file" id="imageInput" accept="image/*">
        </div>
      </div>
      
      <!-- æŒ‰é’®ç»„ -->
      <div class="button-group">
        <button id="analyzeBtn" class="primary-btn">
          <span>ğŸ”</span> <span id="analyzeBtnText">AIè¯†åˆ«åœ°æ ‡</span>
        </button>
        <button id="speakBtn" class="secondary-btn" disabled>
          <span>ğŸ”Š</span> <span id="speakBtnText">è¯­éŸ³æ’­æŠ¥</span>
        </button>
        <button id="clearBtn" class="secondary-btn">
          <span>ğŸ—‘ï¸</span> <span id="clearBtnText">æ¸…é™¤å†…å®¹</span>
        </button>
      </div>
      
      <!-- å›¾ç‰‡é¢„è§ˆ -->
      <div class="preview-section">
        <div class="preview-title" id="previewTitle">å›¾ç‰‡é¢„è§ˆ</div>
        <img id="preview" alt="é¢„è§ˆå›¾ç‰‡" />
      </div>
      
      <!-- åŠ è½½çŠ¶æ€ -->
      <div id="loading">
        <div class="spinner"></div>
        <p class="loading-text" id="loadingText">AI æ­£åœ¨è¯†åˆ«ä¸­ï¼Œè¯·ç¨å€™...</p>
      </div>
    </div>
    
    <!-- å³ä¾§é¢æ¿ -->
    <div class="right-panel">
      <div class="output-header">
        <div class="output-title" id="outputTitle">ğŸ“ è¯†åˆ«ç»“æœ</div>
        <div class="output-actions">
          <button class="action-btn" id="copyBtn">
            <span id="copyBtnText">ğŸ“‹ å¤åˆ¶</span>
          </button>
          <button class="action-btn" id="saveBtn">
            <span id="saveBtnText">ğŸ’¾ ä¿å­˜</span>
          </button>
        </div>
      </div>
      
      <!-- ç»“æœè¾“å‡ºåŒºåŸŸ -->
      <div id="output" data-placeholder="è¯†åˆ«ç»“æœå°†åœ¨æ­¤æ˜¾ç¤º..."></div>
    </div>
  </div>

  <footer>
    <span id="footerText">Powered by Ollama + LLaVA | Designed by Jerry</span>
  </footer>

  <script>
    // è·å–DOMå…ƒç´ 
    const imageInput = document.getElementById('imageInput');
    const dropArea = document.getElementById('dropArea');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const speakBtn = document.getElementById('speakBtn');
    const clearBtn = document.getElementById('clearBtn');
    const copyBtn = document.getElementById('copyBtn');
    const saveBtn = document.getElementById('saveBtn');
    const preview = document.getElementById('preview');
    const output = document.getElementById('output');
    const loading = document.getElementById('loading');
    const languageSelect = document.getElementById('languageSelect');
    const languageInfo = document.getElementById('languageInfo');
    
    // è·å–æ‰€æœ‰éœ€è¦ç¿»è¯‘çš„æ–‡æœ¬å…ƒç´ 
    const appTitle = document.getElementById('appTitle');
    const languageLabel = document.getElementById('languageLabel');
    const appSubtitle = document.getElementById('appSubtitle');
    const uploadText = document.getElementById('uploadText');
    const uploadHint = document.getElementById('uploadHint');
    const analyzeBtnText = document.getElementById('analyzeBtnText');
    const speakBtnText = document.getElementById('speakBtnText');
    const clearBtnText = document.getElementById('clearBtnText');
    const previewTitle = document.getElementById('previewTitle');
    const outputTitle = document.getElementById('outputTitle');
    const copyBtnText = document.getElementById('copyBtnText');
    const saveBtnText = document.getElementById('saveBtnText');
    const loadingText = document.getElementById('loadingText');
    const footerText = document.getElementById('footerText');
    
    // è¯­éŸ³åˆæˆç›¸å…³
    let isSpeaking = false;
    
    // å½“å‰è¯­è¨€
    let currentLanguage = 'zh';
    
    // å¤šè¯­è¨€æ–‡æœ¬èµ„æº
    const languageResources = {
      zh: {
        appTitle: "åœ°æ ‡å‘ç°è€…",
        languageLabel: "è¯­è¨€:",
        languageInfo: "âœ… ä¸­æ–‡å’Œè‹±æ–‡æ”¯æŒæœ€ä½³ | âœ… Chinese & English best supported",
        appSubtitle: "ä¸Šä¼ åœ°æ ‡ç…§ç‰‡ï¼ŒAIç”Ÿæˆå¯¼è§ˆä»‹ç»",
        uploadText: "ç‚¹å‡»é€‰æ‹©æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤åŒºåŸŸ",
        uploadHint: "æ”¯æŒ JPGã€PNG æ ¼å¼",
        analyzeBtnText: "AIè¯†åˆ«åœ°æ ‡",
        speakBtnText: "è¯­éŸ³æ’­æŠ¥",
        clearBtnText: "æ¸…é™¤å†…å®¹",
        previewTitle: "å›¾ç‰‡é¢„è§ˆ",
        outputTitle: "ğŸ“ è¯†åˆ«ç»“æœ",
        copyBtnText: "ğŸ“‹ å¤åˆ¶",
        saveBtnText: "ğŸ’¾ ä¿å­˜",
        loadingText: "AI æ­£åœ¨è¯†åˆ«ä¸­ï¼Œè¯·ç¨å€™...",
        footerText: "Powered by Ollama + LLaVA | Designed by Jerry",
        outputPlaceholder: "è¯†åˆ«ç»“æœå°†åœ¨æ­¤æ˜¾ç¤º...",
        noImageError: "è¯·å…ˆé€‰æ‹©ä¸€å¼ å›¾ç‰‡ï¼",
        notLandmarkMessage: "è¿™ä¸æ˜¯åœ°æ ‡å›¾ç‰‡ï¼Œè¯·ä¸Šä¼ åœ°æ ‡å»ºç­‘ç…§ç‰‡ã€‚",
        connectionError: "è¿æ¥é”™è¯¯ï¼Œè¯·æ£€æŸ¥OllamaæœåŠ¡æ˜¯å¦è¿è¡Œã€‚",
        frenchFallbackInfo: "æ³•è¯­è¯†åˆ«å¯èƒ½ä¸ç¨³å®šï¼Œæ­£åœ¨ä½¿ç”¨è‹±æ–‡è¯†åˆ«...",
        processingText: "æ­£åœ¨å¤„ç†æ‚¨çš„è¯·æ±‚..."
      },
      en: {
        appTitle: "LandMarkFinder",
        languageLabel: "Language:",
        languageInfo: "âœ… Chinese & English best supported | âš ï¸ French experimental",
        appSubtitle: "Upload a landmark photo, AI generates guided tour introduction",
        uploadText: "Click to select or drag image here",
        uploadHint: "Supports JPG, PNG formats",
        analyzeBtnText: "AI Recognize Landmark",
        speakBtnText: "Voice Narration",
        clearBtnText: "Clear Content",
        previewTitle: "Image Preview",
        outputTitle: "ğŸ“ Recognition Results",
        copyBtnText: "ğŸ“‹ Copy",
        saveBtnText: "ğŸ’¾ Save",
        loadingText: "AI is analyzing, please wait...",
        footerText: "Powered by Ollama + LLaVA | Designed by Jerry",
        outputPlaceholder: "Recognition results will appear here...",
        noImageError: "Please select an image first!",
        notLandmarkMessage: "This is not a landmark image, please upload a photo of a landmark building.",
        connectionError: "Connection error, please check if Ollama service is running.",
        frenchFallbackInfo: "French recognition may be unstable, using English recognition...",
        processingText: "Processing your request..."
      },
      fr: {
        appTitle: "DÃ©couvreur de Monuments",
        languageLabel: "Langue:",
        languageInfo: "âš ï¸ Reconnaissance franÃ§aise expÃ©rimentale | âœ… Chinois & Anglais mieux supportÃ©s",
        appSubtitle: "TÃ©lÃ©chargez une photo de monument, l'IA gÃ©nÃ¨re une introduction guidÃ©e",
        uploadText: "Cliquez pour sÃ©lectionner ou faites glisser l'image ici",
        uploadHint: "Prend en charge les formats JPG, PNG",
        analyzeBtnText: "IA ReconnaÃ®tre le Monument",
        speakBtnText: "Narration Vocale",
        clearBtnText: "Effacer le Contenu",
        previewTitle: "AperÃ§u de l'Image",
        outputTitle: "ğŸ“ RÃ©sultats de Reconnaissance",
        copyBtnText: "ğŸ“‹ Copier",
        saveBtnText: "ğŸ’¾ Enregistrer",
        loadingText: "L'IA analyse, veuillez patienter...",
        footerText: "PropulsÃ© par Ollama + LLaVA | ConÃ§u par Jerry",
        outputPlaceholder: "Les rÃ©sultats de reconnaissance apparaÃ®tront ici...",
        noImageError: "Veuillez d'abord sÃ©lectionner une image!",
        notLandmarkMessage: "Ce n'est pas une image de monument, veuillez tÃ©lÃ©charger une photo d'un bÃ¢timent cÃ©lÃ¨bre.",
        connectionError: "Erreur de connexion, veuillez vÃ©rifier si le service Ollama fonctionne.",
        frenchFallbackInfo: "La reconnaissance franÃ§aise peut Ãªtre instable, utilisation de la reconnaissance anglaise...",
        processingText: "Traitement de votre demande..."
      }
    };
    
    // æ›´æ–°ç•Œé¢è¯­è¨€
    function updateLanguage(lang) {
      currentLanguage = lang;
      const resources = languageResources[lang];
      
      // æ›´æ–°æ‰€æœ‰æ–‡æœ¬å…ƒç´ 
      appTitle.textContent = resources.appTitle;
      languageLabel.textContent = resources.languageLabel;
      languageInfo.textContent = resources.languageInfo;
      appSubtitle.textContent = resources.appSubtitle;
      uploadText.textContent = resources.uploadText;
      uploadHint.textContent = resources.uploadHint;
      analyzeBtnText.textContent = resources.analyzeBtnText;
      speakBtnText.textContent = resources.speakBtnText;
      clearBtnText.textContent = resources.clearBtnText;
      previewTitle.textContent = resources.previewTitle;
      outputTitle.textContent = resources.outputTitle;
      copyBtnText.textContent = resources.copyBtnText;
      saveBtnText.textContent = resources.saveBtnText;
      loadingText.textContent = resources.loadingText;
      footerText.textContent = resources.footerText;
      output.setAttribute('data-placeholder', resources.outputPlaceholder);
      
      // ä¿å­˜è¯­è¨€é€‰æ‹©åˆ°æœ¬åœ°å­˜å‚¨
      localStorage.setItem('landmarkFinderLanguage', lang);
    }
    
    // æ˜¾ç¤ºæç¤ºä¿¡æ¯
    function showInfo(message) {
      // ç§»é™¤å·²æœ‰çš„ä¿¡æ¯æç¤º
      const existingInfo = document.querySelector('.info-message');
      if (existingInfo) {
        existingInfo.remove();
      }
      
      // åˆ›å»ºæ–°çš„ä¿¡æ¯æç¤º
      const infoDiv = document.createElement('div');
      infoDiv.className = 'info-message';
      infoDiv.textContent = message;
      
      document.body.appendChild(infoDiv);
      
      // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
      setTimeout(() => {
        infoDiv.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => {
          if (infoDiv.parentNode) {
            infoDiv.parentNode.removeChild(infoDiv);
          }
        }, 300);
      }, 3000);
    }
    
    // æ˜¾ç¤ºé”™è¯¯æç¤º
    function showError(message) {
      // ç§»é™¤å·²æœ‰çš„é”™è¯¯æç¤º
      const existingError = document.querySelector('.error-message');
      if (existingError) {
        existingError.remove();
      }
      
      // åˆ›å»ºæ–°çš„é”™è¯¯æç¤º
      const errorDiv = document.createElement('div');
      errorDiv.className = 'error-message';
      errorDiv.textContent = message;
      
      document.body.appendChild(errorDiv);
      
      // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
      setTimeout(() => {
        errorDiv.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => {
          if (errorDiv.parentNode) {
            errorDiv.parentNode.removeChild(errorDiv);
          }
        }, 300);
      }, 3000);
    }
    
    // å›¾ç‰‡è½¬Base64
    async function toBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.onerror = error => reject(error);
        reader.readAsDataURL(file);
      });
    }
    
    // æ–‡ä»¶æ‹–æ”¾åŠŸèƒ½
    dropArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropArea.classList.add('dragover');
    });
    
    dropArea.addEventListener('dragleave', () => {
      dropArea.classList.remove('dragover');
    });
    
    dropArea.addEventListener('drop', (e) => {
      e.preventDefault();
      dropArea.classList.remove('dragover');
      
      if (e.dataTransfer.files.length) {
        imageInput.files = e.dataTransfer.files;
        handleImageSelect();
      }
    });
    
    // å›¾ç‰‡é€‰æ‹©å¤„ç†
    imageInput.addEventListener('change', handleImageSelect);
    
    function handleImageSelect() {
      const file = imageInput.files[0];
      if (!file) return;
      
      preview.src = URL.createObjectURL(file);
      preview.style.display = 'block';
      analyzeBtn.disabled = false;
    }
    
    // æ ¹æ®å½“å‰è¯­è¨€è·å–æç¤ºè¯ - ä¼˜åŒ–ç‰ˆæœ¬
    function getPromptForLanguage(lang) {
      const prompts = {
        zh: `è¯·è¯†åˆ«å›¾ç‰‡ä¸­çš„åœ°æ ‡æˆ–å»ºç­‘ï¼Œå¹¶ç”¨ä¸­æ–‡è¿›è¡Œè¯¦ç»†ä»‹ç»ã€‚å¦‚æœè¿™ä¸æ˜¯åœ°æ ‡æˆ–å»ºç­‘ï¼Œè¯·ç›´æ¥è¯´"è¿™ä¸æ˜¯åœ°æ ‡å›¾ç‰‡"ã€‚`,
        en: `Please identify and describe this landmark or building in English with detailed information. If this is not a landmark, only say "This is not a landmark image."`,
        fr: `DÃ©cris cette image en franÃ§ais. Si c'est un monument ou un bÃ¢timent cÃ©lÃ¨bre, donne une description dÃ©taillÃ©e en franÃ§ais. Si ce n'est pas un monument, dis simplement "Ce n'est pas un monument."`
      };
      return prompts[lang] || prompts['en'];
    }
    
    // æ³•è¯­å¤‡é€‰æç¤ºè¯ï¼ˆå¦‚æœæ³•è¯­å¤±è´¥ï¼Œä½¿ç”¨è‹±æ–‡ï¼‰
    function getFrenchFallbackPrompt() {
      return `Please identify this landmark or building and describe it in French. If it's not a landmark, say "Ce n'est pas un monument." Answer in French only.`;
    }
    
    // æ£€æŸ¥æ˜¯å¦ä¸ºæœ‰æ•ˆçš„åœ°æ ‡è¯†åˆ«ç»“æœ
    function isValidLandmarkResponse(text, lang) {
      if (!text || text.trim().length < 10) return false;
      
      // æ£€æŸ¥æ˜¯å¦åŒ…å«éåœ°æ ‡çš„å…³é”®è¯
      const notLandmarkPatterns = {
        zh: ['ä¸æ˜¯åœ°æ ‡å›¾ç‰‡', 'ä¸æ˜¯åœ°æ ‡', 'éåœ°æ ‡', 'æ— æ³•è¯†åˆ«'],
        en: ['not a landmark image', 'not a landmark', 'is not a landmark', 'cannot identify'],
        fr: ["n'est pas un monument", 'pas un monument', 'ce n\'est pas un monument', 'pas de monument']
      };
      
      const patterns = notLandmarkPatterns[lang];
      if (patterns) {
        const lowerText = text.toLowerCase();
        for (const pattern of patterns) {
          if (lowerText.includes(pattern.toLowerCase())) {
            return false;
          }
        }
      }
      
      // æ£€æŸ¥æ˜¯å¦æœ‰å®è´¨å†…å®¹
      const minLength = 50; // è‡³å°‘50ä¸ªå­—ç¬¦æ‰è®¤ä¸ºæ˜¯æœ‰æ•ˆçš„æè¿°
      return text.trim().length >= minLength;
    }
    
    // AIåˆ†æå›¾ç‰‡
    analyzeBtn.onclick = async () => {
      const file = imageInput.files[0];
      if (!file) {
        showError(languageResources[currentLanguage].noImageError);
        return;
      }
      
      // é‡ç½®çŠ¶æ€
      output.textContent = '';
      loading.style.display = 'block';
      speakBtn.disabled = true;
      analyzeBtn.disabled = true;
      
      try {
        const base64 = await toBase64(file);
        
        console.log(`å‘é€è¯·æ±‚åˆ° Ollama... è¯­è¨€: ${currentLanguage}`);
        
        // æ ¹æ®å½“å‰è¯­è¨€è·å–æç¤ºè¯
        let prompt = getPromptForLanguage(currentLanguage);
        let isFrenchFallback = false;
        
        // å¦‚æœæ˜¯æ³•è¯­ï¼Œæ·»åŠ å¤‡é€‰æ–¹æ¡ˆä¿¡æ¯
        if (currentLanguage === 'fr') {
          showInfo(languageResources[currentLanguage].frenchFallbackInfo);
          // å…ˆå°è¯•ä½¿ç”¨ä¼˜åŒ–çš„æ³•è¯­æç¤ºè¯
          prompt = getPromptForLanguage('fr');
        }
        
        const response = await fetch('http://localhost:11434/api/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            model: 'llava',
            prompt: prompt,
            images: [base64],
            stream: true,
            options: {
              temperature: 0.7,
              num_predict: 400
            }
          })
        });
        
        if (!response.ok) {
          throw new Error(`HTTPé”™è¯¯: ${response.status}`);
        }
        
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let fullText = '';
        
        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          
          const chunk = decoder.decode(value);
          const lines = chunk.trim().split('\n');
          
          for (const line of lines) {
            if (!line.trim()) continue;
            
            try {
              const json = JSON.parse(line);
              if (json.response) {
                fullText += json.response;
                output.textContent = fullText;
                output.scrollTop = output.scrollHeight;
              }
            } catch (e) {
              console.log('è§£æè¡Œ:', line);
            }
          }
        }
        
        console.log('å®Œæˆ! ç»“æœ:', fullText);
        
        // æ£€æŸ¥ç»“æœæ˜¯å¦æœ‰æ•ˆ
        let isValid = isValidLandmarkResponse(fullText, currentLanguage);
        
        // å¦‚æœæ˜¯æ³•è¯­ä¸”ç»“æœæ— æ•ˆï¼Œå°è¯•ä½¿ç”¨è‹±æ–‡å¤‡é€‰
        if (currentLanguage === 'fr' && !isValid && fullText.length > 0 && !isFrenchFallback) {
          console.log('æ³•è¯­è¯†åˆ«å¯èƒ½å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨è‹±æ–‡å¤‡é€‰æ–¹æ¡ˆ...');
          showInfo(languageResources[currentLanguage].frenchFallbackInfo);
          
          // ä¿å­˜å½“å‰ç»“æœ
          const originalResult = fullText;
          
          // ä½¿ç”¨è‹±æ–‡å¤‡é€‰æç¤ºè¯é‡æ–°å°è¯•
          const fallbackPrompt = getFrenchFallbackPrompt();
          
          const fallbackResponse = await fetch('http://localhost:11434/api/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              model: 'llava',
              prompt: fallbackPrompt,
              images: [base64],
              stream: true,
              options: {
                temperature: 0.7,
                num_predict: 400
              }
            })
          });
          
          if (fallbackResponse.ok) {
            const fallbackReader = fallbackResponse.body.getReader();
            let fallbackText = '';
            
            while (true) {
              const { done, value } = await fallbackReader.read();
              if (done) break;
              
              const chunk = decoder.decode(value);
              const lines = chunk.trim().split('\n');
              
              for (const line of lines) {
                if (!line.trim()) continue;
                
                try {
                  const json = JSON.parse(line);
                  if (json.response) {
                    fallbackText += json.response;
                  }
                } catch (e) {
                  console.log('å¤‡é€‰è§£æè¡Œ:', line);
                }
              }
            }
            
            console.log('å¤‡é€‰æ–¹æ¡ˆç»“æœ:', fallbackText);
            
            // æ£€æŸ¥å¤‡é€‰ç»“æœæ˜¯å¦æœ‰æ•ˆ
            if (isValidLandmarkResponse(fallbackText, 'fr') || fallbackText.length > originalResult.length) {
              fullText = fallbackText;
              output.textContent = fullText;
              isValid = true;
              isFrenchFallback = true;
            }
          }
        }
        
        // æœ€ç»ˆåˆ¤æ–­
        if (!isValid) {
          // éåœ°æ ‡å›¾ç‰‡æˆ–æ— æ•ˆå“åº”
          speakBtn.disabled = true;
          if (fullText.trim().length > 0) {
            // æœ‰å“åº”ä½†ä¸æ˜¯åœ°æ ‡
            showError(languageResources[currentLanguage].notLandmarkMessage);
          } else {
            // ç©ºå“åº”æˆ–æ— æ•ˆå“åº”
            output.textContent = languageResources[currentLanguage].connectionError;
          }
        } else {
          // æˆåŠŸè¯†åˆ«
          speakBtn.disabled = false;
          
          // å¦‚æœæ˜¯æ³•è¯­å¤‡é€‰æ–¹æ¡ˆçš„ç»“æœï¼Œæ·»åŠ è¯´æ˜
          if (isFrenchFallback && currentLanguage === 'fr') {
            const note = "\n\n[Note: La reconnaissance franÃ§aise a utilisÃ© un modÃ¨le de secours en anglais pour amÃ©liorer la prÃ©cision.]";
            fullText += note;
            output.textContent = fullText;
          }
        }
        
      } catch (error) {
        console.error('è¯·æ±‚å¤±è´¥:', error);
        output.textContent = languageResources[currentLanguage].connectionError + "\n\nError: " + error.message;
        showError(languageResources[currentLanguage].connectionError);
      } finally {
        loading.style.display = 'none';
        analyzeBtn.disabled = false;
      }
    };
    
    // è¯­éŸ³æ’­æŠ¥åŠŸèƒ½
    speakBtn.onclick = () => {
      const text = output.textContent;
      if (!text.trim()) return;
      
      if (isSpeaking) {
        window.speechSynthesis.cancel();
        isSpeaking = false;
        speakBtn.innerHTML = '<span>ğŸ”Š</span> <span id="speakBtnText">' + languageResources[currentLanguage].speakBtnText + '</span>';
        return;
      }
      
      // è·å–å¯ç”¨è¯­éŸ³
      const voices = window.speechSynthesis.getVoices();
      
      // æ ¹æ®å½“å‰è¯­è¨€é€‰æ‹©è¯­éŸ³
      let targetVoice;
      let targetLang;
      
      if (currentLanguage === 'zh') {
        targetLang = 'zh-CN';
        targetVoice = voices.find(v => v.lang === 'zh-CN' || v.lang.startsWith('zh'));
      } else if (currentLanguage === 'en') {
        targetLang = 'en-US';
        targetVoice = voices.find(v => v.lang === 'en-US' || v.lang.startsWith('en'));
      } else if (currentLanguage === 'fr') {
        targetLang = 'fr-FR';
        targetVoice = voices.find(v => v.lang === 'fr-FR' || v.lang.startsWith('fr'));
      }
      
      // åˆ†å‰²æ–‡æœ¬
      const sentences = text.split(/(?<=[ã€‚.!?\n])/).filter(s => s.trim().length > 0);
      
      if (sentences.length === 0) return;
      
      // é€å¥æ’­æŠ¥
      isSpeaking = true;
      const stopText = currentLanguage === 'zh' ? 'åœæ­¢æ’­æŠ¥' : 
                      currentLanguage === 'en' ? 'Stop Narration' : 
                      'ArrÃªter la Narration';
      speakBtn.innerHTML = '<span>â¸ï¸</span> <span id="speakBtnText">' + stopText + '</span>';
      
      let currentIndex = 0;
      
      function speakNext() {
        if (currentIndex >= sentences.length) {
          isSpeaking = false;
          speakBtn.innerHTML = '<span>ğŸ”Š</span> <span id="speakBtnText">' + languageResources[currentLanguage].speakBtnText + '</span>';
          return;
        }
        
        const sentence = sentences[currentIndex].trim();
        const utterance = new SpeechSynthesisUtterance(sentence);
        
        // è®¾ç½®è¯­éŸ³å‚æ•°
        utterance.lang = targetLang;
        utterance.voice = targetVoice || voices[0];
        utterance.rate = 0.85;
        utterance.pitch = 1.0;
        utterance.volume = 1.0;
        
        utterance.onend = () => {
          currentIndex++;
          setTimeout(speakNext, 300);
        };
        
        utterance.onerror = () => {
          currentIndex++;
          setTimeout(speakNext, 300);
        };
        
        window.speechSynthesis.speak(utterance);
      }
      
      speakNext();
    };
    
    // æ¸…é™¤å†…å®¹
    clearBtn.onclick = () => {
      output.textContent = '';
      speakBtn.disabled = true;
      speakBtn.innerHTML = '<span>ğŸ”Š</span> <span id="speakBtnText">' + languageResources[currentLanguage].speakBtnText + '</span>';
      
      if (isSpeaking) {
        window.speechSynthesis.cancel();
        isSpeaking = false;
      }
    };
    
    // å¤åˆ¶ç»“æœ
    copyBtn.onclick = () => {
      const text = output.textContent;
      if (!text.trim()) return;
      
      navigator.clipboard.writeText(text).then(() => {
        const originalText = copyBtnText.textContent;
        copyBtnText.textContent = currentLanguage === 'zh' ? 'âœ“ å·²å¤åˆ¶' : 
                                  currentLanguage === 'en' ? 'âœ“ Copied' : 'âœ“ CopiÃ©';
        setTimeout(() => {
          copyBtnText.textContent = originalText;
        }, 2000);
      }).catch(err => {
        console.error('å¤åˆ¶å¤±è´¥:', err);
        const errorMsg = currentLanguage === 'zh' ? 'å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©æ–‡æœ¬å¤åˆ¶' :
                         currentLanguage === 'en' ? 'Copy failed, please select and copy manually' :
                         'Ã‰chec de la copie, veuillez sÃ©lectionner et copier manuellement';
        alert(errorMsg);
      });
    };
    
    // ä¿å­˜ç»“æœ
    saveBtn.onclick = () => {
      const text = output.textContent;
      if (!text.trim()) return;
      
      const blob = new Blob([text], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `LandMarkFinder_${currentLanguage}_${new Date().toISOString().slice(0, 10)}.txt`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      const originalText = saveBtnText.textContent;
      saveBtnText.textContent = currentLanguage === 'zh' ? 'âœ“ å·²ä¿å­˜' : 
                                currentLanguage === 'en' ? 'âœ“ Saved' : 'âœ“ EnregistrÃ©';
      setTimeout(() => {
        saveBtnText.textContent = originalText;
      }, 2000);
    };
    
    // è¯­è¨€é€‰æ‹©å™¨äº‹ä»¶ç›‘å¬
    languageSelect.addEventListener('change', (e) => {
      const selectedLanguage = e.target.value;
      updateLanguage(selectedLanguage);
    });
    
    // åˆå§‹åŒ–
    analyzeBtn.disabled = true;
    
    // æ£€æŸ¥æœ¬åœ°å­˜å‚¨çš„è¯­è¨€è®¾ç½®
    const savedLanguage = localStorage.getItem('landmarkFinderLanguage');
    if (savedLanguage && languageResources[savedLanguage]) {
      currentLanguage = savedLanguage;
      languageSelect.value = savedLanguage;
      updateLanguage(savedLanguage);
    }
    
    // æ£€æŸ¥OllamaæœåŠ¡
    async function checkOllamaService() {
      try {
        const response = await fetch('http://localhost:11434/api/tags', {
          method: 'GET'
        });
        
        if (response.ok) {
          const data = await response.json();
          const hasLlava = data.models?.some(m => m.name.includes('llava'));
          console.log('âœ… OllamaæœåŠ¡è¿æ¥æ­£å¸¸, LLaVAæ¨¡å‹:', hasLlava ? 'å·²ä¸‹è½½' : 'æœªæ‰¾åˆ°');
          if (!hasLlava) {
            showInfo('LLaVAæ¨¡å‹æœªæ‰¾åˆ°ï¼Œè¯·è¿è¡Œ: ollama pull llava');
          }
        } else {
          console.warn('âš ï¸ OllamaæœåŠ¡å¼‚å¸¸');
        }
      } catch (error) {
        console.warn('æ— æ³•è¿æ¥åˆ°OllamaæœåŠ¡ï¼Œè¯·è¿è¡Œ: ollama serve');
        showError('æ— æ³•è¿æ¥åˆ°OllamaæœåŠ¡ï¼Œè¯·ç¡®ä¿å·²è¿è¡Œ: ollama serve');
      }
    }
    
    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æœåŠ¡
    window.addEventListener('load', checkOllamaService);
    
    // é¢„åŠ è½½è¯­éŸ³åˆ—è¡¨
    if ('speechSynthesis' in window) {
      speechSynthesis.onvoiceschanged = () => {
        const voices = speechSynthesis.getVoices();
        console.log('è¯­éŸ³åˆ—è¡¨å·²åŠ è½½ï¼Œæ•°é‡:', voices.length);
        
        // æ˜¾ç¤ºå¯ç”¨è¯­éŸ³ä¿¡æ¯ï¼ˆè°ƒè¯•ç”¨ï¼‰
        const chineseVoices = voices.filter(v => v.lang.startsWith('zh'));
        const englishVoices = voices.filter(v => v.lang.startsWith('en'));
        const frenchVoices = voices.filter(v => v.lang.startsWith('fr'));
        
        console.log('ä¸­æ–‡è¯­éŸ³:', chineseVoices.length);
        console.log('è‹±æ–‡è¯­éŸ³:', englishVoices.length);
        console.log('æ³•è¯­è¯­éŸ³:', frenchVoices.length);
      };
    }
  </script>
</body>
</html>