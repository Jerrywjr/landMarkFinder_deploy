<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<title>ğŸ›ï¸ LandMarkFinder - AIåœ°æ ‡è¯†åˆ«å¯¼è§ˆåŠ©æ‰‹</title>
<style>
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  body {
    font-family: "Inter", "Helvetica Neue", Arial, sans-serif;
    background: linear-gradient(145deg, #e0f2fe, #f8fafc);
    margin: 0;
    padding: 20px;
    min-height: 100vh;
  }

  .container {
    display: flex;
    max-width: 1200px;
    margin: 0 auto;
    gap: 30px;
    height: calc(100vh - 40px);
  }

  .left-panel, .right-panel {
    background: rgba(255, 255, 255, 0.85);
    backdrop-filter: blur(10px);
    border-radius: 20px;
    box-shadow: 0 10px 35px rgba(0, 0, 0, 0.1);
    padding: 30px;
    transition: 0.3s;
  }

  .left-panel {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .right-panel {
    flex: 1.5;
    display: flex;
    flex-direction: column;
  }

  h2 {
    font-weight: 700;
    color: #0f172a;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    margin-bottom: 10px;
  }

  .subtitle {
    color: #475569;
    text-align: center;
    margin-bottom: 30px;
    font-size: 15px;
  }

  .upload-area {
    width: 100%;
    margin-bottom: 30px;
  }

  .file-input-container {
    position: relative;
    width: 100%;
    height: 200px;
    border: 3px dashed #cbd5e1;
    border-radius: 16px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s;
    background: #f8fafc;
  }

  .file-input-container:hover {
    border-color: #3b82f6;
    background: #f0f9ff;
  }

  .file-input-container.dragover {
    border-color: #3b82f6;
    background: #dbeafe;
  }

  .upload-icon {
    font-size: 48px;
    color: #94a3b8;
    margin-bottom: 15px;
  }

  .upload-text {
    color: #64748b;
    font-size: 16px;
    margin-bottom: 5px;
  }

  .upload-hint {
    color: #94a3b8;
    font-size: 14px;
  }

  input[type="file"] {
    position: absolute;
    width: 100%;
    height: 100%;
    opacity: 0;
    cursor: pointer;
  }

  .button-group {
    display: flex;
    flex-direction: column;
    gap: 15px;
    width: 100%;
  }

  button {
    width: 100%;
    padding: 14px;
    border: none;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
  }

  .primary-btn {
    background: linear-gradient(135deg, #3b82f6, #2563eb);
    color: white;
    box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
  }

  .primary-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 18px rgba(37, 99, 235, 0.35);
  }

  .secondary-btn {
    background: #f1f5f9;
    color: #475569;
    border: 2px solid #e2e8f0;
  }

  .secondary-btn:hover {
    background: #e2e8f0;
  }

  .preview-section {
    width: 100%;
    margin-top: 30px;
    text-align: center;
  }

  .preview-title {
    color: #475569;
    font-size: 16px;
    margin-bottom: 15px;
    font-weight: 500;
  }

  #preview {
    max-width: 100%;
    max-height: 200px;
    border-radius: 12px;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
    display: none;
  }

  .output-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }

  .output-title {
    color: #0f172a;
    font-size: 18px;
    font-weight: 600;
  }

  .output-actions {
    display: flex;
    gap: 10px;
  }

  .action-btn {
    background: #f1f5f9;
    border: none;
    border-radius: 8px;
    padding: 8px 15px;
    cursor: pointer;
    font-size: 14px;
    color: #475569;
    transition: all 0.2s;
  }

  .action-btn:hover {
    background: #e2e8f0;
  }

  #output {
    flex: 1;
    border-radius: 12px;
    padding: 20px;
    border: none;
    font-size: 15px;
    line-height: 1.6;
    color: #334155;
    background: #f1f5f9;
    white-space: pre-wrap;
    overflow-y: auto;
    font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
    min-height: 300px;
  }

  #output:empty::before {
    content: "è¯†åˆ«ç»“æœå°†åœ¨æ­¤æ˜¾ç¤º...";
    color: #94a3b8;
    font-style: italic;
  }

  #loading {
    display: none;
    margin: 20px 0;
    text-align: center;
  }

  .spinner {
    border: 4px solid #e2e8f0;
    border-top: 4px solid #3b82f6;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: 0 auto 15px;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  .loading-text {
    color: #64748b;
    font-size: 15px;
  }

  footer {
    margin-top: 30px;
    text-align: center;
    font-size: 13px;
    color: #94a3b8;
  }

  footer span {
    background: #f1f5f9;
    padding: 6px 12px;
    border-radius: 12px;
  }

  /* å“åº”å¼è°ƒæ•´ */
  @media (max-width: 768px) {
    .container {
      flex-direction: column;
      height: auto;
    }
    
    .left-panel, .right-panel {
      width: 100%;
    }
  }

  /* æ–°å¢çš„æ ·å¼ - è¯­éŸ³æ’­æŠ¥å’Œé”™è¯¯æç¤º */
  @keyframes slideIn {
    from {
      transform: translateX(100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }
  
  @keyframes slideOut {
    from {
      transform: translateX(0);
      opacity: 1;
    }
    to {
      transform: translateX(100%);
      opacity: 0;
    }
  }
  
  button.active {
    background: linear-gradient(135deg, #ef4444, #dc2626) !important;
    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3) !important;
  }
  
  #output.error {
    background: #fee2e2 !important;
    color: #dc2626 !important;
    border: 1px solid #fca5a5 !important;
  }
  
  .language-tag {
    display: inline-block;
    background: #dbeafe;
    color: #1e40af;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 12px;
    margin-right: 8px;
    font-weight: bold;
  }
</style>
</head>
<body>
  <div class="container">
    <!-- å·¦ä¾§é¢æ¿ -->
    <div class="left-panel">
      <h2>ğŸ›ï¸ <span>LandMarkFinder</span></h2>
      <p class="subtitle">ä¸Šä¼ åœ°æ ‡ç…§ç‰‡ï¼ŒAIç”Ÿæˆä¸­è‹±æ–‡å¯¼è§ˆä»‹ç»</p>
      
      <!-- ä¸Šä¼ åŒºåŸŸ -->
      <div class="upload-area">
        <div class="file-input-container" id="dropArea">
          <div class="upload-icon">ğŸ“</div>
          <div class="upload-text">ç‚¹å‡»é€‰æ‹©æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤åŒºåŸŸ</div>
          <div class="upload-hint">æ”¯æŒ JPGã€PNG æ ¼å¼</div>
          <input type="file" id="imageInput" accept="image/*">
        </div>
      </div>
      
      <!-- æŒ‰é’®ç»„ -->
      <div class="button-group">
        <button id="analyzeBtn" class="primary-btn">
          <span>ğŸ”</span> AIè¯†åˆ«åœ°æ ‡
        </button>
        <button id="speakBtn" class="secondary-btn" disabled>
          <span>ğŸ”Š</span> è¯­éŸ³æ’­æŠ¥
        </button>
        <button id="clearBtn" class="secondary-btn">
          <span>ğŸ—‘ï¸</span> æ¸…é™¤å†…å®¹
        </button>
      </div>
      
      <!-- å›¾ç‰‡é¢„è§ˆ -->
      <div class="preview-section">
        <div class="preview-title">å›¾ç‰‡é¢„è§ˆ</div>
        <img id="preview" alt="é¢„è§ˆå›¾ç‰‡" />
      </div>
      
      <!-- åŠ è½½çŠ¶æ€ -->
      <div id="loading">
        <div class="spinner"></div>
        <p class="loading-text">AI æ­£åœ¨è¯†åˆ«ä¸­ï¼Œè¯·ç¨å€™...</p>
      </div>
    </div>
    
    <!-- å³ä¾§é¢æ¿ -->
    <div class="right-panel">
      <div class="output-header">
        <div class="output-title">ğŸ“ è¯†åˆ«ç»“æœ</div>
        <div class="output-actions">
          <button class="action-btn" id="copyBtn">ğŸ“‹ å¤åˆ¶</button>
          <button class="action-btn" id="saveBtn">ğŸ’¾ ä¿å­˜</button>
        </div>
      </div>
      
      <!-- ç»“æœè¾“å‡ºåŒºåŸŸ -->
      <div id="output"></div>
    </div>
  </div>

  <footer>
    <span>Powered by Ollama + LLaVA | Designed by Jerry</span>
  </footer>

  <script>
    // è·å–DOMå…ƒç´ 
    const imageInput = document.getElementById('imageInput');
    const dropArea = document.getElementById('dropArea');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const speakBtn = document.getElementById('speakBtn');
    const clearBtn = document.getElementById('clearBtn');
    const copyBtn = document.getElementById('copyBtn');
    const saveBtn = document.getElementById('saveBtn');
    const preview = document.getElementById('preview');
    const output = document.getElementById('output');
    const loading = document.getElementById('loading');
    
    // è¯­éŸ³åˆæˆç›¸å…³
    let isSpeaking = false;
    let currentSpeechUtterances = [];
    
    // å›¾ç‰‡è½¬Base64
    async function toBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.onerror = error => reject(error);
        reader.readAsDataURL(file);
      });
    }
    
    // æ˜¾ç¤ºé”™è¯¯æç¤º
    function showError(message) {
      // åˆ›å»ºæˆ–è·å–é”™è¯¯æç¤ºå…ƒç´ 
      let errorDiv = document.getElementById('error-message');
      if (!errorDiv) {
        errorDiv = document.createElement('div');
        errorDiv.id = 'error-message';
        errorDiv.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          background: #ef4444;
          color: white;
          padding: 12px 20px;
          border-radius: 8px;
          box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
          z-index: 1000;
          max-width: 300px;
          animation: slideIn 0.3s ease;
        `;
        document.body.appendChild(errorDiv);
      }
      
      errorDiv.textContent = message;
      
      // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
      setTimeout(() => {
        errorDiv.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => {
          if (errorDiv.parentNode) {
            errorDiv.parentNode.removeChild(errorDiv);
          }
        }, 300);
      }, 3000);
    }
    
    // æ–‡ä»¶æ‹–æ”¾åŠŸèƒ½
    dropArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropArea.classList.add('dragover');
    });
    
    dropArea.addEventListener('dragleave', () => {
      dropArea.classList.remove('dragover');
    });
    
    dropArea.addEventListener('drop', (e) => {
      e.preventDefault();
      dropArea.classList.remove('dragover');
      
      if (e.dataTransfer.files.length) {
        imageInput.files = e.dataTransfer.files;
        handleImageSelect();
      }
    });
    
    // å›¾ç‰‡é€‰æ‹©å¤„ç†
    imageInput.addEventListener('change', handleImageSelect);
    
    function handleImageSelect() {
      const file = imageInput.files[0];
      if (!file) return;
      
      // æ˜¾ç¤ºé¢„è§ˆ
      preview.src = URL.createObjectURL(file);
      preview.style.display = 'block';
      
      // å¯ç”¨åˆ†ææŒ‰é’®
      analyzeBtn.disabled = false;
    }
    
    // å›¾ç‰‡éªŒè¯å‡½æ•°
    function validateImage(file) {
      // æ£€æŸ¥æ–‡ä»¶ç±»å‹
      const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp', 'image/gif'];
      if (!validTypes.includes(file.type)) {
        showError('è¯·é€‰æ‹©æœ‰æ•ˆçš„å›¾ç‰‡æ ¼å¼ (JPEG, PNG, WebP)');
        return false;
      }
      
      // æ£€æŸ¥æ–‡ä»¶å¤§å° (é™åˆ¶ä¸º5MB)
      const maxSize = 5 * 1024 * 1024; // 5MB
      if (file.size > maxSize) {
        showError('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡5MBï¼Œè¯·å‹ç¼©åé‡è¯•');
        return false;
      }
      
      return true;
    }
    
    // AIåˆ†æå›¾ç‰‡ - æ”¹è¿›ç‰ˆ
    analyzeBtn.onclick = async () => {
      const file = imageInput.files[0];
      if (!file) {
        showError('è¯·å…ˆé€‰æ‹©ä¸€å¼ å›¾ç‰‡ï¼');
        return;
      }
      
      // éªŒè¯å›¾ç‰‡ç±»å‹å’Œå¤§å°
      if (!validateImage(file)) {
        return;
      }
      
      // æ¸…ç©ºä¹‹å‰çš„è¾“å‡º
      output.textContent = '';
      output.classList.remove('error');
      loading.style.display = 'block';
      speakBtn.disabled = true;
      analyzeBtn.disabled = true;
      
      try {
        const base64 = await toBase64(file);
        
        // è®¾ç½®è¶…æ—¶æ§åˆ¶å™¨
        const controller = new AbortController();
        const timeoutId = setTimeout(() => {
          controller.abort();
          showError('è¯·æ±‚è¶…æ—¶ï¼Œè¯·ç¡®ä¿ Ollama æœåŠ¡æ­£åœ¨è¿è¡Œ');
          loading.style.display = 'none';
          analyzeBtn.disabled = false;
        }, 30000); // 30ç§’è¶…æ—¶ï¼ˆæ›´å¿«ï¼ï¼‰
        
        // ï¼ï¼ï¼å…³é”®æ”¹è¿›ï¼šæ›´ä¸¥æ ¼çš„æç¤ºè¯ ï¼ï¼ï¼
        const prompt = `ä¸¥æ ¼æŒ‰ä»¥ä¸‹è§„åˆ™åˆ†æå›¾ç‰‡ï¼š

**è§„åˆ™1ï¼šå¦‚æœæ˜¯åœ°æ ‡/å»ºç­‘**
- è¾“å‡ºæ ¼å¼ï¼š
  [EN_START]è‹±æ–‡ä»‹ç»å†…å®¹[EN_END]
  [ZH_START]ä¸­æ–‡ä»‹ç»å†…å®¹[ZH_END]

**è§„åˆ™2ï¼šå¦‚æœä¸æ˜¯åœ°æ ‡**
- å¦‚æœæ˜¯é£æ™¯ã€åŠ¨ç‰©ã€é£Ÿç‰©ã€äººç‰©ã€æ—¥å¸¸ç‰©å“ç­‰éåœ°æ ‡ï¼šè¾“å‡º "[ERROR_NON_LANDMARK]"
- å¦‚æœå›¾ç‰‡æ¨¡ç³Šã€æ— æ³•è¯†åˆ«ï¼šè¾“å‡º "[ERROR_BAD_IMAGE]"

**è§„åˆ™3ï¼šåˆ¤æ–­æ ‡å‡†**
åœ°æ ‡åŒ…æ‹¬ï¼šçŸ¥åå»ºç­‘ã€å¤è¿¹ã€çºªå¿µç¢‘ã€æ ‡å¿—æ€§æ™¯ç‚¹ã€è‘—åæ¡¥æ¢ã€æ•™å ‚ã€å¯ºåº™ã€åŸå ¡ã€å®«æ®¿ã€å†å²é—å€ç­‰ã€‚

**ç°åœ¨å¼€å§‹åˆ†æï¼š`;
        
        const response = await fetch('http://localhost:11434/api/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            model: 'llava',
            prompt: prompt,
            images: [base64],
            stream: true,
            options: {
              temperature: 0.2,  // æ›´ä½éšæœºæ€§ï¼Œæ›´ç¡®å®š
              num_predict: 400   // é™åˆ¶ç”Ÿæˆé•¿åº¦
            }
          }),
          signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        if (!response.ok) {
          throw new Error(`HTTPé”™è¯¯ï¼çŠ¶æ€ç : ${response.status}`);
        }
        
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let fullText = '';
        let hasStarted = false;
        const startTime = Date.now();
        
        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          
          const chunk = decoder.decode(value);
          const lines = chunk.trim().split('\n');
          
          for (const line of lines) {
            if (!line.trim()) continue;
            
            try {
              const json = JSON.parse(line);
              if (json.response) {
                fullText += json.response;
                
                // å®æ—¶æ˜¾ç¤º
                output.textContent = fullText;
                output.scrollTop = output.scrollHeight;
                
                // !!! å…³é”®æ”¹è¿›ï¼šå¿«é€Ÿæ£€æµ‹é”™è¯¯å…³é”®è¯ !!!
                if (!hasStarted) {
                  hasStarted = true;
                  
                  // æ£€æŸ¥æ˜¯å¦æ˜¯éåœ°æ ‡å›¾ç‰‡ï¼ˆå¿«é€Ÿä¸­æ–­ï¼ï¼‰
                  if (json.response.includes('[ERROR_NON_LANDMARK]') || 
                      json.response.includes('[ERROR_BAD_IMAGE]')) {
                    // ç«‹å³åœæ­¢è¯»å–
                    reader.cancel();
                    
                    // ç›´æ¥æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                    output.textContent = json.response;
                    output.classList.add('error');
                    
                    // è½¬æ¢ä¸ºå‹å¥½çš„é”™è¯¯æ¶ˆæ¯
                    if (json.response.includes('[ERROR_NON_LANDMARK]')) {
                      showError('è¿™ä¸æ˜¯åœ°æ ‡å›¾ç‰‡ï¼è¯·ä¸Šä¼ åœ°æ ‡å»ºç­‘ç…§ç‰‡');
                      output.textContent = 'âŒ é”™è¯¯ï¼šè¿™ä¸æ˜¯åœ°æ ‡å›¾ç‰‡\n\nè¯·ä¸Šä¼ ä»¥ä¸‹ç±»å‹çš„ç…§ç‰‡ï¼š\nâ€¢ è‘—åå»ºç­‘ï¼ˆå¦‚åŸƒè²å°”é“å¡”ï¼‰\nâ€¢ å¤è¿¹å¯ºåº™ï¼ˆå¦‚å¤©å›ï¼‰\nâ€¢ çºªå¿µç¢‘\nâ€¢ æ ‡å¿—æ€§æ™¯ç‚¹\nâ€¢ å†å²é—å€';
                    } else if (json.response.includes('[ERROR_BAD_IMAGE]')) {
                      showError('å›¾ç‰‡è´¨é‡ä¸ä½³ï¼Œæ— æ³•è¯†åˆ«');
                      output.textContent = 'âŒ é”™è¯¯ï¼šå›¾ç‰‡æ¨¡ç³Šæˆ–æ— æ³•è¯†åˆ«\n\nè¯·ä¸Šä¼ æ¸…æ™°çš„åœ°æ ‡å»ºç­‘ç…§ç‰‡';
                    }
                    
                    // ä¸éœ€è¦è¿›ä¸€æ­¥å¤„ç†
                    loading.style.display = 'none';
                    analyzeBtn.disabled = false;
                    return;
                  }
                }
              }
            } catch (e) {
              console.warn('è§£æJSONæ—¶å‡ºé”™:', e, 'è¡Œå†…å®¹:', line);
            }
          }
        }
        
        // å¤„ç†æœ€ç»ˆç»“æœ
        processFinalResult(fullText);
        
      } catch (error) {
        if (error.name === 'AbortError') {
          output.textContent = 'â±ï¸ è¯·æ±‚è¶…æ—¶ï¼šAIå¤„ç†æ—¶é—´è¿‡é•¿\n\nå¯èƒ½åŸå› ï¼š\n1. OllamaæœåŠ¡æœªè¿è¡Œ\n2. å›¾ç‰‡å¤ªå¤§\n3. ç½‘ç»œé—®é¢˜\n\nè¯·å°è¯•ï¼š\n1. æ£€æŸ¥OllamaæœåŠ¡ (ollama serve)\n2. ä¸Šä¼ æ›´å°çš„å›¾ç‰‡';
        } else {
          output.textContent = `âŒ é”™è¯¯: ${error.message}\n\nè¯·ç¡®ä¿ï¼š\n1. OllamaæœåŠ¡æ­£åœ¨è¿è¡Œ (ç»ˆç«¯æ‰§è¡Œ: ollama serve)\n2. LLaVAæ¨¡å‹å·²ä¸‹è½½ (ollama pull llava)`;
        }
        output.classList.add('error');
        console.error('åˆ†æå‡ºé”™:', error);
      } finally {
        loading.style.display = 'none';
        analyzeBtn.disabled = false;
      }
    };
    
    // å¤„ç†æœ€ç»ˆç»“æœ
    function processFinalResult(fullText) {
      // æ£€æŸ¥æ˜¯å¦åŒ…å«é”™è¯¯
      if (fullText.includes('[ERROR_NON_LANDMARK]') || 
          fullText.includes('[ERROR_BAD_IMAGE]')) {
        output.classList.add('error');
        speakBtn.disabled = true;
        
        if (fullText.includes('[ERROR_NON_LANDMARK]')) {
          showError('è¿™ä¸æ˜¯åœ°æ ‡å›¾ç‰‡ï¼è¯·ä¸Šä¼ åœ°æ ‡å»ºç­‘ç…§ç‰‡');
          output.textContent = 'âŒ é”™è¯¯ï¼šè¿™ä¸æ˜¯åœ°æ ‡å›¾ç‰‡\n\nè¯·ä¸Šä¼ ä»¥ä¸‹ç±»å‹çš„ç…§ç‰‡ï¼š\nâ€¢ è‘—åå»ºç­‘ï¼ˆå¦‚åŸƒè²å°”é“å¡”ï¼‰\nâ€¢ å¤è¿¹å¯ºåº™ï¼ˆå¦‚å¤©å›ï¼‰\nâ€¢ çºªå¿µç¢‘\nâ€¢ æ ‡å¿—æ€§æ™¯ç‚¹\nâ€¢ å†å²é—å€';
        } else {
          showError('å›¾ç‰‡è´¨é‡ä¸ä½³ï¼Œæ— æ³•è¯†åˆ«');
          output.textContent = 'âŒ é”™è¯¯ï¼šå›¾ç‰‡æ¨¡ç³Šæˆ–æ— æ³•è¯†åˆ«\n\nè¯·ä¸Šä¼ æ¸…æ™°çš„åœ°æ ‡å»ºç­‘ç…§ç‰‡';
        }
        return;
      }
      
      // è§£æä¸­è‹±æ–‡å†…å®¹
      let enContent = '';
      let zhContent = '';
      
      // å°è¯•æå–è‹±æ–‡å†…å®¹
      const enMatch = fullText.match(/\[EN_START\]([\s\S]*?)\[EN_END\]/);
      if (enMatch && enMatch[1]) {
        enContent = enMatch[1].trim();
      }
      
      // å°è¯•æå–ä¸­æ–‡å†…å®¹
      const zhMatch = fullText.match(/\[ZH_START\]([\s\S]*?)\[ZH_END\]/);
      if (zhMatch && zhMatch[1]) {
        zhContent = zhMatch[1].trim();
      }
      
      // æ ¼å¼åŒ–æ˜¾ç¤º
      let formattedText = '';
      if (enContent) {
        formattedText += 'ğŸ‡¬ğŸ‡§ è‹±æ–‡ä»‹ç»ï¼š\n' + enContent + '\n\n';
      }
      if (zhContent) {
        formattedText += 'ğŸ‡¨ğŸ‡³ ä¸­æ–‡ä»‹ç»ï¼š\n' + zhContent;
      }
      
      // å¦‚æœæ²¡æœ‰æå–åˆ°æ ¼å¼åŒ–çš„å†…å®¹ï¼Œæ˜¾ç¤ºåŸå§‹æ–‡æœ¬
      if (!enContent && !zhContent) {
        formattedText = fullText;
      }
      
      output.textContent = formattedText;
      
      // ä¿å­˜æå–çš„å†…å®¹ç”¨äºè¯­éŸ³æ’­æŠ¥
      output.dataset.enContent = enContent;
      output.dataset.zhContent = zhContent;
      
      // å¯ç”¨è¯­éŸ³æ’­æŠ¥æŒ‰é’®
      speakBtn.disabled = false;
    }
    
    // è¯­éŸ³æ’­æŠ¥åŠŸèƒ½ - å®Œå…¨é‡å†™ï¼
    speakBtn.onclick = () => {
      if (isSpeaking) {
        // åœæ­¢æ‰€æœ‰è¯­éŸ³
        window.speechSynthesis.cancel();
        isSpeaking = false;
        currentSpeechUtterances = [];
        speakBtn.innerHTML = '<span>ğŸ”Š</span> è¯­éŸ³æ’­æŠ¥';
        speakBtn.classList.remove('active');
        return;
      }
      
      // è·å–ä¸­è‹±æ–‡å†…å®¹
      const enContent = output.dataset.enContent || '';
      const zhContent = output.dataset.zhContent || '';
      
      if (!enContent && !zhContent) {
        // å¦‚æœæ²¡æœ‰æå–çš„å†…å®¹ï¼Œä½¿ç”¨æ•´ä¸ªæ–‡æœ¬
        const fullText = output.textContent;
        if (!fullText.trim()) return;
        
        // ç®€å•è¯­è¨€æ£€æµ‹å¹¶æ’­æŠ¥
        simpleTextToSpeech(fullText);
        return;
      }
      
      // !!! å…³é”®æ”¹è¿›ï¼šåˆ†åˆ«ç”¨æ­£ç¡®è¯­éŸ³æ’­æŠ¥ä¸­è‹±æ–‡ !!!
      currentSpeechUtterances = [];
      
      // è·å–å¯ç”¨è¯­éŸ³
      const voices = window.speechSynthesis.getVoices();
      const chineseVoice = voices.find(v => v.lang === 'zh-CN' || v.lang.startsWith('zh'));
      const englishVoice = voices.find(v => v.lang === 'en-US' || v.lang.startsWith('en'));
      
      // æ’­æŠ¥è‹±æ–‡å†…å®¹ï¼ˆç”¨è‹±è¯­è¯­éŸ³ï¼‰
      if (enContent.trim()) {
        const enUtterance = new SpeechSynthesisUtterance(enContent);
        enUtterance.lang = 'en-US';
        enUtterance.voice = englishVoice || voices[0];
        enUtterance.rate = 0.9;
        enUtterance.pitch = 1.0;
        enUtterance.volume = 1.0;
        
        currentSpeechUtterances.push(enUtterance);
      }
      
      // æ’­æŠ¥ä¸­æ–‡å†…å®¹ï¼ˆç”¨ä¸­æ–‡è¯­éŸ³ï¼‰
      if (zhContent.trim()) {
        const zhUtterance = new SpeechSynthesisUtterance(zhContent);
        zhUtterance.lang = 'zh-CN';
        zhUtterance.voice = chineseVoice || voices[0];
        zhUtterance.rate = 0.85;
        zhUtterance.pitch = 1.0;
        zhUtterance.volume = 1.0;
        
        currentSpeechUtterances.push(zhUtterance);
      }
      
      if (currentSpeechUtterances.length === 0) {
        showError('æ²¡æœ‰å¯æ’­æŠ¥çš„å†…å®¹');
        return;
      }
      
      // å¼€å§‹æ’­æŠ¥
      isSpeaking = true;
      speakBtn.innerHTML = '<span>â¸ï¸</span> åœæ­¢æ’­æŠ¥';
      speakBtn.classList.add('active');
      
      // é€æ®µæ’­æŠ¥
      let currentIndex = 0;
      
      function speakNext() {
        if (currentIndex >= currentSpeechUtterances.length) {
          isSpeaking = false;
          speakBtn.innerHTML = '<span>ğŸ”Š</span> è¯­éŸ³æ’­æŠ¥';
          speakBtn.classList.remove('active');
          return;
        }
        
        const utterance = currentSpeechUtterances[currentIndex];
        utterance.onend = () => {
          currentIndex++;
          setTimeout(speakNext, 500); // æ®µè½é—´åœé¡¿500ms
        };
        
        utterance.onerror = (event) => {
          console.error('è¯­éŸ³æ’­æŠ¥å‡ºé”™:', event);
          currentIndex++;
          setTimeout(speakNext, 500);
        };
        
        window.speechSynthesis.speak(utterance);
      }
      
      speakNext();
    };
    
    // ç®€å•æ–‡æœ¬è½¬è¯­éŸ³ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
    function simpleTextToSpeech(text) {
      // åˆ†æ®µå¤„ç†
      const segments = text.split(/(?<=[ã€‚.!?\n])/).filter(s => s.trim().length > 0);
      
      if (segments.length === 0) return;
      
      const voices = window.speechSynthesis.getVoices();
      currentSpeechUtterances = [];
      
      // ä¸ºæ¯æ®µåˆ›å»ºè¯­éŸ³
      segments.forEach(segment => {
        const utterance = new SpeechSynthesisUtterance(segment.trim());
        
        // æ£€æµ‹è¯­è¨€
        const hasChinese = /[\u4e00-\u9fa5]/.test(segment);
        const hasEnglish = /[a-zA-Z]/.test(segment);
        
        if (hasChinese && !hasEnglish) {
          // çº¯ä¸­æ–‡
          utterance.lang = 'zh-CN';
          utterance.rate = 0.85;
        } else if (hasEnglish && !hasChinese) {
          // çº¯è‹±æ–‡
          utterance.lang = 'en-US';
          utterance.rate = 0.9;
        } else {
          // æ··åˆï¼Œé»˜è®¤ç”¨ä¸­æ–‡
          utterance.lang = 'zh-CN';
          utterance.rate = 0.85;
        }
        
        currentSpeechUtterances.push(utterance);
      });
      
      // å¼€å§‹æ’­æŠ¥
      isSpeaking = true;
      speakBtn.innerHTML = '<span>â¸ï¸</span> åœæ­¢æ’­æŠ¥';
      speakBtn.classList.add('active');
      
      let currentIndex = 0;
      
      function speakNext() {
        if (currentIndex >= currentSpeechUtterances.length) {
          isSpeaking = false;
          speakBtn.innerHTML = '<span>ğŸ”Š</span> è¯­éŸ³æ’­æŠ¥';
          speakBtn.classList.remove('active');
          return;
        }
        
        const utterance = currentSpeechUtterances[currentIndex];
        utterance.onend = () => {
          currentIndex++;
          setTimeout(speakNext, 300);
        };
        
        window.speechSynthesis.speak(utterance);
      }
      
      speakNext();
    }
    
    // æ¸…é™¤å†…å®¹
    clearBtn.onclick = () => {
      output.textContent = '';
      output.classList.remove('error');
      delete output.dataset.enContent;
      delete output.dataset.zhContent;
      speakBtn.disabled = true;
      speakBtn.innerHTML = '<span>ğŸ”Š</span> è¯­éŸ³æ’­æŠ¥';
      speakBtn.classList.remove('active');
      
      // åœæ­¢è¯­éŸ³æ’­æŠ¥
      if (isSpeaking) {
        window.speechSynthesis.cancel();
        isSpeaking = false;
        currentSpeechUtterances = [];
      }
    };
    
    // å¤åˆ¶ç»“æœ
    copyBtn.onclick = () => {
      const text = output.textContent;
      if (!text.trim()) return;
      
      navigator.clipboard.writeText(text).then(() => {
        const originalText = copyBtn.textContent;
        copyBtn.textContent = 'âœ“ å·²å¤åˆ¶';
        setTimeout(() => {
          copyBtn.textContent = originalText;
        }, 2000);
      }).catch(err => {
        console.error('å¤åˆ¶å¤±è´¥:', err);
        alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©æ–‡æœ¬å¤åˆ¶');
      });
    };
    
    // ä¿å­˜ç»“æœ
    saveBtn.onclick = () => {
      const text = output.textContent;
      if (!text.trim()) return;
      
      const blob = new Blob([text], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `LandMarkFinder_ç»“æœ_${new Date().toISOString().slice(0, 10)}.txt`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      const originalText = saveBtn.textContent;
      saveBtn.textContent = 'âœ“ å·²ä¿å­˜';
      setTimeout(() => {
        saveBtn.textContent = originalText;
      }, 2000);
    };
    
    // åˆå§‹åŒ–æ—¶ç¦ç”¨åˆ†ææŒ‰é’®
    analyzeBtn.disabled = true;
    
    // ç›‘å¬è¯­éŸ³åˆæˆçŠ¶æ€
    if ('speechSynthesis' in window) {
      // é¢„åŠ è½½è¯­éŸ³åˆ—è¡¨
      window.speechSynthesis.onvoiceschanged = () => {
        console.log('è¯­éŸ³åˆ—è¡¨å·²åŠ è½½ï¼Œå¯ç”¨è¯­éŸ³æ•°:', speechSynthesis.getVoices().length);
      };
    }
    
    // æ£€æŸ¥OllamaæœåŠ¡æ˜¯å¦å¯ç”¨
    async function checkOllamaService() {
      try {
        const response = await fetch('http://localhost:11434/api/tags', {
          method: 'GET',
          headers: { 'Content-Type': 'application/json' }
        });
        
        if (response.ok) {
          console.log('âœ… OllamaæœåŠ¡è¿æ¥æ­£å¸¸');
        } else {
          console.warn('âš ï¸ OllamaæœåŠ¡è¿æ¥å¼‚å¸¸');
        }
      } catch (error) {
        console.warn('âŒ æ— æ³•è¿æ¥åˆ°OllamaæœåŠ¡ï¼Œè¯·ç¡®ä¿å·²è¿è¡Œ: ollama serve');
      }
    }
    
    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æœåŠ¡
    window.addEventListener('load', checkOllamaService);
  </script>
</body>
</html>